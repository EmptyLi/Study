```sql
WITH RATING_SEQ AS
 (SELECT '正面1' AS RATING, '-1' AS SEQ
    FROM DUAL
  UNION ALL
  SELECT '正面1' AS RATING, '0' AS SEQ
    FROM DUAL
  UNION ALL
  SELECT '正面1' AS RATING, '1' AS SEQ
    FROM DUAL
  UNION ALL
  SELECT '正面2+' AS RATING, '2' AS SEQ
    FROM DUAL
  UNION ALL
  SELECT '正面2' AS RATING, '3' AS SEQ
    FROM DUAL
  UNION ALL
  SELECT '正面2-' AS RATING, '4' AS SEQ
    FROM DUAL
  UNION ALL
  SELECT '中性1+' AS RATING, '5' AS SEQ
    FROM DUAL
  UNION ALL
  SELECT '中性1' AS RATING, '6' AS SEQ
    FROM DUAL
  UNION ALL
  SELECT '中性1-' AS RATING, '7' AS SEQ
    FROM DUAL
  UNION ALL
  SELECT '中性2+' AS RATING, '8' AS SEQ
    FROM DUAL
  UNION ALL
  SELECT '中性2' AS RATING, '9' AS SEQ
    FROM DUAL
  UNION ALL
  SELECT '中性2-' AS RATING, '10' AS SEQ
    FROM DUAL
  UNION ALL
  SELECT '负面1+' AS RATING, '11' AS SEQ
    FROM DUAL
  UNION ALL
  SELECT '负面1' AS RATING, '12' AS SEQ
    FROM DUAL
  UNION ALL
  SELECT '负面1-' AS RATING, '13' AS SEQ
    FROM DUAL
  UNION ALL
  SELECT '负面2+' AS RATING, '14' AS SEQ
    FROM DUAL
  UNION ALL
  SELECT '负面2' AS RATING, '15' AS SEQ
    FROM DUAL
  UNION ALL
  SELECT '负面2-' AS RATING, '16' AS SEQ
    FROM DUAL
  UNION ALL
  SELECT '违约级' AS RATING, '17' AS SEQ
    FROM DUAL),

TEMP_BOND_BASICINFO AS
 (SELECT A.SECINNER_ID, A.SECURITY_CD || C.MARKET_ABBR AS SECURITY_CD
    FROM (SELECT DISTINCT SECINNER_ID, SECURITY_CD, TRADE_MARKET_ID
            FROM BOND_BASICINFO
           WHERE ISDEL = 0) A
    JOIN LKP_CHARCODE B
      ON A.TRADE_MARKET_ID = B.CONSTANT_ID
     AND B.CONSTANT_TYPE = 206
    JOIN LKP_MARKET_ABBR C
      ON B.CONSTANT_CD = C.MARKET_CD),
BOND_RESULT AS
 (SELECT A.SECURITY_CD, C.SECINNER_ID
    FROM RAY_BOND_LIST A
    LEFT JOIN TEMP_BOND_BASICINFO C
      ON C.SECURITY_CD = A.SECURITY_CD),
BOND_BASIC AS
 (SELECT T.SECURITY_CD,
         T2.SECURITY_SNM,
         T1.COMPANY_ID,
         T1.COMPANY_NM,
         T1.REMAIN_VOL
    FROM BOND_RESULT T
    LEFT JOIN VW_BOND_RATING_CACUL_T T1
      ON T1.CLIENT_ID = 5
     AND T1.SECINNER_ID = T.SECINNER_ID
    LEFT JOIN BOND_BASICINFO T2
      ON T2.SECINNER_ID = T.SECINNER_ID
   WHERE T.SECINNER_ID IS NOT NULL
   ORDER BY T.SECURITY_CD),
BOND_OTHER_ORIG AS
 (SELECT T.SECURITY_CD,
         T1.CORP_NATURE   AS "Z",
         T1.INDUSTRY      AS "AA",
         T1.CREDIT_REGION AS "AB",
         T1.BOND_TYPE     AS "AC"
    FROM BOND_RESULT T
    LEFT JOIN VW_BOND_RATING_CACUL_T T1
      ON T1.SECINNER_ID = T.SECINNER_ID
     AND T1.CLIENT_ID = 5
   WHERE T.SECINNER_ID IS NOT NULL),
BOND_OTHER_LIST AS
 (SELECT SECURITY_CD, TY, TMP_VALUE
    FROM BOND_OTHER_ORIG UNPIVOT(TMP_VALUE FOR TY IN(Z, AA, AB, AC))),
BOND_OTHER_TRANS AS
 (SELECT A.*, TT.OPTION_NUM, TT.RATIO1
    FROM BOND_OTHER_LIST A
    LEFT JOIN RAY_BOND_FACTOR_OPTION TT
      ON A.TMP_VALUE = TT.OPTION1),
BOND_OTHER_OPTION AS
 (SELECT *
    FROM (SELECT A.SECURITY_CD, A.TY, A.OPTION_NUM FROM BOND_OTHER_TRANS A)
  PIVOT(MAX(OPTION_NUM)
     FOR TY IN('Z' AS "Z", 'AA' AS "AA", 'AB' AS "AB", 'AC' AS "AC"))),
BOND_OTHER_RATIO AS
 (SELECT *
    FROM (SELECT A.SECURITY_CD, A.TY, A.RATIO1 FROM BOND_OTHER_TRANS A)
  PIVOT(MAX(RATIO1)
     FOR TY IN('Z' AS "AX", 'AA' AS "AY", 'AB' AS "AZ", 'AC' AS "BA"))),
TMP_BOND_WARROR AS
 (SELECT A.SECURITY_CD,
         K1.COMPANY_ID       AS "AD",
         K.WARRANTOR_NM      AS "AE",
         K.GUARANTEE_TYPE    AS "AF",
         K.WARRANTOR_TYPE    AS "AG",
         K.WARRANTY_STRENGTH AS "AH",
         K.WARRANTY_VALUE    AS "AI",
         K3.FINAL_RATING     AS "P1"
    FROM BOND_RESULT A
   INNER JOIN VW_BOND_RATING_CACUL_WARRANTOR K
      ON K.CLIENT_ID = 5
     AND A.SECINNER_ID = K.SECINNER_ID
    LEFT JOIN COMPY_BASICINFO K1
      ON K1.COMPANY_NM = K.WARRANTOR_NM
    LEFT JOIN RATING_DISPLAY K2
      ON K2.COMPANY_ID = K1.COMPANY_ID
    LEFT JOIN RATING_RECORD K3
      ON K3.RATING_RECORD_ID = K2.RATING_RECORD_ID),
BOND_WARROR_LIST AS
 (SELECT *
    FROM (SELECT * FROM TMP_BOND_WARROR) UNPIVOT(TMP_VALUE FOR TP IN(AF,
                                                                     AG,
                                                                     AH))),
BOND_WARROR_TRANS AS
 (SELECT A.*, H.OPTION_NUM, H.RATIO1
    FROM BOND_WARROR_LIST A
    LEFT JOIN RAY_BOND_FACTOR_OPTION H
      ON H.OPTION1 = A.TMP_VALUE),
BOND_WARROR_OPTION AS
 (SELECT *
    FROM (SELECT A.SECURITY_CD, A.AD, A.AE, A.AI, A.TP, A.OPTION_NUM
            FROM BOND_WARROR_TRANS A)
  PIVOT(MAX(OPTION_NUM)
     FOR TP IN('AF' AS "AF", 'AG' AS "AG", 'AH' AS "AH"))),
BOND_WARROR_RATIO AS
 (SELECT *
    FROM (SELECT A.SECURITY_CD, A.AD, A.AE, A.TP, A.AI AS "BE", A.RATIO1
            FROM BOND_WARROR_TRANS A)
  PIVOT(MAX(RATIO1)
     FOR TP IN('AF' AS "BB", 'AG' AS "BC", 'AH' AS "BD"))),
TMP_BOND_PLEDGE AS
 (SELECT A.SECURITY_CD,
         Q.PLEDGE_VALUE,
         Q.PLEDGE_TYPE,
         Q.PLEDGE_CONTROL,
         Q.PLEDGE_DEPEND,
         Q.PLEDGE_REGION
    FROM BOND_RESULT A
   INNER JOIN VW_BOND_RATING_CACUL_PLEDGE Q
      ON A.SECINNER_ID = Q.SECINNER_ID
     AND Q.CLIENT_ID = 5),
BOND_PLEDGE_LIST AS
 (SELECT *
    FROM TMP_BOND_PLEDGE UNPIVOT(TMP_VALUE FOR TP IN(PLEDGE_TYPE,
                                                     PLEDGE_CONTROL,
                                                     PLEDGE_DEPEND,
                                                     PLEDGE_REGION))),
BOND_PLEDGE_TRANS AS
 (SELECT A.*, P.OPTION_NUM, P.RATIO1
    FROM BOND_PLEDGE_LIST A
    LEFT JOIN RAY_BOND_FACTOR_OPTION P
      ON P.OPTION1 = A.TMP_VALUE
   WHERE P.FACTOR_CD NOT IN ('CREDIT_REGION')),
BOND_PLEDGE_OPTION AS
 (SELECT *
    FROM (SELECT A.SECURITY_CD, A.PLEDGE_VALUE, A.TP, A.OPTION_NUM
            FROM BOND_PLEDGE_TRANS A)
  PIVOT(MAX(OPTION_NUM)
     FOR TP IN('PLEDGE_TYPE' AS "PLEDGE_TYPE",
              'PLEDGE_CONTROL' AS "PLEDGE_CONTROL",
              'PLEDGE_DEPEND' AS "PLEDGE_DEPEND",
              'PLEDGE_REGION' AS "PLEDGE_REGION"))),
BOND_PLEDGE_RATIO AS
 (SELECT *
    FROM (SELECT A.SECURITY_CD, A.PLEDGE_VALUE, A.TP, A.RATIO1
            FROM BOND_PLEDGE_TRANS A)
  PIVOT(MAX(RATIO1)
     FOR TP IN('PLEDGE_TYPE' AS "PLEDGE_TYPE_ADJ",
              'PLEDGE_CONTROL' AS "PLEDGE_CONTROL_ADJ",
              'PLEDGE_DEPEND' AS "PLEDGE_DEPEND_ADJ",
              'PLEDGE_REGION' AS "PLEDGE_REGION_ADJ"))),
BOND_LEDGE_SUM AS
 (SELECT SECURITY_CD,
         SUM(PLEDGE_VALUE * PLEDGE_TYPE_ADJ * PLEDGE_CONTROL_ADJ *
             PLEDGE_DEPEND_ADJ * PLEDGE_REGION_ADJ) AS TOTAL
    FROM BOND_PLEDGE_RATIO
   GROUP BY SECURITY_CD),
MULTI_WARROR_AVG_PD AS
 (SELECT A.SECURITY_CD,
         A.AE,
         F.FINAL_RATING,
         HH.MID_PD,
         AVG(HH.MID_PD) OVER(PARTITION BY A.SECURITY_CD) AS AVG_MID_PD
    FROM TMP_BOND_WARROR A
    LEFT JOIN RATING_DISPLAY F
      ON F.COMPANY_ID = A.AD
     AND F.CLIENT_ID = 5
    LEFT JOIN RATING_MASTER_SCALE HH
      ON HH.RATING = F.FINAL_RATING),
MULTI_WARROR_RATING AS
 (SELECT DISTINCT SECURITY_CD, B.RATING
    FROM MULTI_WARROR_AVG_PD A
    LEFT JOIN RATING_MASTER_SCALE B
      ON B.MIN_VAL < A.AVG_MID_PD
     AND B.MAX_VAL > A.AVG_MID_PD),
MULTI_WARROR AS
 (SELECT A.SECURITY_CD, SUM(A.BE * A.BB * A.BC * A.BD) AS TOTAL
    FROM BOND_WARROR_RATIO A
   GROUP BY A.SECURITY_CD),
TMP AS
 (SELECT A.SECURITY_CD, A.AX * A.AY * A.AZ AS "W" FROM BOND_OTHER_RATIO A),
TMP_SWX AS
 (SELECT A.*,
         B.TOTAL AS "U",
         C.TOTAL AS "V",
         D.W AS "W",
         E.BA AS "X",
         CASE
           WHEN NVL(B.TOTAL, 0) + NVL(C.TOTAL, 0) > 0 THEN
            (NVL(B.TOTAL, 0) + NVL(C.TOTAL, 0)) / F.REMAIN_VOL
           ELSE
            0.35
         END AS "TXXXX",
         F.REMAIN_VOL AS "Y"
    FROM BOND_RESULT A
    LEFT JOIN MULTI_WARROR B
      ON A.SECURITY_CD = B.SECURITY_CD
    LEFT JOIN BOND_LEDGE_SUM C
      ON A.SECURITY_CD = C.SECURITY_CD
    LEFT JOIN TMP D
      ON A.SECURITY_CD = D.SECURITY_CD
    LEFT JOIN BOND_OTHER_RATIO E
      ON A.SECURITY_CD = E.SECURITY_CD
    LEFT JOIN BOND_BASIC F
      ON A.SECURITY_CD = F.SECURITY_CD

  ),
RESULT_IMPORT AS
 (SELECT A.SECURITY_CD,
         G.ADJUST_RATING,
         G1.RATING,
         G2.RAW_RATING,
         G4.FINAL_RATING,
         G2.RAW_LGD_GRADE,

         G2.RAW_LGD_SCORE,
         1 - G5.W * G5.X * NVL((CASE
                                 WHEN NVL(G5.TXXXX, 0) < 1.05 THEN
                                  NVL(G5.TXXXX, 0)
                                 ELSE
                                  1.05
                               END),
                               1) AS "R",
         (CASE
           WHEN G5.TXXXX < 1.05 THEN
            G5.TXXXX
           ELSE
            1.05
         END) AS "S",
         G5.TXXXX AS "T",
         G5.U AS "U",
         NVL(G5.V, 0) AS "V",
         G5.W AS "W",
         G5.X AS "X",
         G5.Y AS "Y",
         G6.Z,
         G6.AA,
         G6.AB,
         G6.AC,
         G7.AD,
         G7.AE,
         G8.AF,
         G8.AG,
         G8.AH,
         G8.AI,
         G7.P1,
         TO_NUMBER(G9.SEQ) AS "P"
    FROM BOND_RESULT A
    LEFT JOIN BOND_RATING_DISPLAY G
      ON A.SECINNER_ID = G.SECINNER_ID
    LEFT JOIN MULTI_WARROR_RATING G1
      ON A.SECURITY_CD = G1.SECURITY_CD
    LEFT JOIN BOND_RATING_RECORD G2
      ON G2.BOND_RATING_RECORD_SID = G.BOND_RATING_RECORD_ID
    LEFT JOIN BOND_BASIC G3
      ON A.SECURITY_CD = G3.SECURITY_CD
    LEFT JOIN RATING_DISPLAY G4
      ON G4.COMPANY_ID = G3.COMPANY_ID
    LEFT JOIN TMP_SWX G5
      ON A.SECURITY_CD = G5.SECURITY_CD
    LEFT JOIN BOND_OTHER_OPTION G6
      ON A.SECURITY_CD = G6.SECURITY_CD
    LEFT JOIN TMP_BOND_WARROR G7
      ON A.SECURITY_CD = G7.SECURITY_CD
    LEFT JOIN BOND_WARROR_OPTION G8
      ON A.SECURITY_CD = G8.SECURITY_CD
     AND G7.AE = G8.AE
    LEFT JOIN RATING_SEQ G9
      ON G7.P1 = G9.RATING),
tmp_1 as (
SELECT A.*,
       RR.SCALE_GRADE AS "Q",
       CASE
         WHEN RR.SCALE_GRADE = 'LGD1' THEN
          A.P - 2
         WHEN RR.SCALE_GRADE = 'LGD2' THEN
          A.P - 1
         ELSE
          A.P
       END AS "O"
  FROM RESULT_IMPORT A
  LEFT JOIN BOND_RATING_SCALE_LGD RR
    ON RR.LOW_BOUND < A.R
   AND RR.UPPER_BOUND > A.R)
/* select a.*, b.RATING as "L", a.P1 AS "M", h1.final_rating as "K" from tmp_1 a
 left join RATING_SEQ b
   on b.seq = a.O
 left join rating_display h1
   on h1.company_id = a.AD
where SECURITY_CD in  (SECURITY_CD)*/
select * from BOND_RESULT where SECURITY_CD = '122828.SH'
/*SELECT SECURITY_CD FROM TMP_BOND_WARROR WHERE SECURITY_CD = '124648.SH';*/
/*SELECT * FROM BOND_PLEDGE_TRANS WHERE SECURITY_CD = '124648.SH';*/

```
