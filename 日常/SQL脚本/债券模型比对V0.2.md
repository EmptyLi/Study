```sql
WITH TEMP_CONF AS
 (SELECT '债项类型' AS INDEX_NM, 'BOND_TYPE' AS INDEX_TP
    FROM DUAL
  UNION ALL
  SELECT '债券风险暴露EAD' AS INDEX_NM, 'REMAIN_VOL' AS INDEX_TP
    FROM DUAL
  UNION ALL
  SELECT '发行人行业分类' AS INDEX_NM, 'INDUSTRY' AS INDEX_TP
    FROM DUAL
  UNION ALL
  SELECT '信用环境' AS INDEX_NM, 'CREDIT_REGION' AS INDEX_TP
    FROM DUAL
  UNION ALL
  SELECT '股权结构' AS INDEX_NM, 'CORP_NATURE' AS INDEX_TP
    FROM DUAL
  UNION ALL
  SELECT '抵质押品执法环境' AS INDEX_NM, 'PLEDGE_REGION' AS INDEX_TP
    FROM DUAL
  UNION ALL
  SELECT '备用1' AS INDEX_NM, 'PRIORITY_VALUE' AS INDEX_TP
    FROM DUAL
  UNION ALL
  SELECT '抵质押品类型' AS INDEX_NM, 'PLEDGE_TYPE' AS INDEX_TP
    FROM DUAL
  UNION ALL
  SELECT '抵质押品价值' AS INDEX_NM, 'PLEDGE_VALUE' AS INDEX_TP
    FROM DUAL
  UNION ALL
  SELECT '抵质押品独立性' AS INDEX_NM, 'PLEDGE_DEPEND' AS INDEX_TP
    FROM DUAL
  UNION ALL
  SELECT '抵质押品控制力' AS INDEX_NM, 'PLEDGE_CONTROL' AS INDEX_TP
    FROM DUAL
  UNION ALL
  SELECT '抵质押品名称' AS INDEX_NM, 'PLEDGE_NM' AS INDEX_TP
    FROM DUAL
  UNION ALL
  SELECT '担保价值（亿元）' AS INDEX_NM, 'WARRANTY_VALUE' AS INDEX_TP
    FROM DUAL
  UNION ALL
  SELECT '担保人类型' AS INDEX_NM, 'WARRANTOR_TYPE' AS INDEX_TP
    FROM DUAL
  UNION ALL
  SELECT '担保类型' AS INDEX_NM, 'GUARANTEE_TYPE' AS INDEX_TP
    FROM DUAL
  UNION ALL
  SELECT '担保人名称' AS INDEX_NM, 'WARRANTOR_NM' AS INDEX_TP
    FROM DUAL
  UNION ALL
  SELECT '担保强度' AS INDEX_NM, 'WARRANTY_STRENGTH' AS INDEX_TP
    FROM DUAL),
TEMP AS
 (SELECT A.*,
         B.OPTION_NUM,
         B.RATIO1,
         NVL(TO_CHAR(B.RATIO1), A.FACTOR_VALUE) AS FINAL_SCORE
    FROM RAY_BOND_RATING_MID1 A
    LEFT JOIN RAY_BOND_FACTOR_OPTION B
      ON B.CLIENT_ID = 5
     AND A.TMP_VALUE = B.FACTOR_CD
     AND A.FACTOR_VALUE = B.OPTION1),
tmp_Ret as
 (select *
    from (SELECT TEMP.secinner_id,
                 temp.company_id,
                 temp.company_nm,
                 temp.exposure,
                 temp.final_score,
                 temp.tmp_value,
                 temp.PLEDGE_NM
            FROM TEMP
            LEFT JOIN TEMP_CONF
              ON TEMP_CONF.INDEX_TP = TEMP.TMP_VALUE)
  pivot(max(final_score)
     for tmp_value in('BOND_TYPE' AS BOND_TYPE,
                     'REMAIN_VOL' AS REMAIN_VOL,
                     'INDUSTRY' AS INDUSTRY,
                     'CREDIT_REGION' AS CREDIT_REGION,
                     'CORP_NATURE' AS CORP_NATURE,
                     'PLEDGE_REGION' AS PLEDGE_REGION,
                     'PRIORITY_VALUE' AS PRIORITY_VALUE,
                     'PLEDGE_TYPE' AS PLEDGE_TYPE,
                     'PLEDGE_VALUE' AS PLEDGE_VALUE,
                     'PLEDGE_DEPEND' AS PLEDGE_DEPEND,
                     'PLEDGE_CONTROL' AS PLEDGE_CONTROL,
                     'WARRANTY_VALUE' AS WARRANTY_VALUE,
                     'WARRANTOR_TYPE' AS WARRANTOR_TYPE,
                     'GUARANTEE_TYPE' AS GUARANTEE_TYPE,
                     'WARRANTOR_NM' AS WARRANTOR_NM,
                     'WARRANTY_STRENGTH' AS WARRANTY_STRENGTH))),
CHK_MID_1 AS
 (

  SELECT A.*, TT.SCALE_GRADE
    FROM (SELECT secinner_id,
                  company_id,
                  company_nm,
                  exposure,
                  1 - nvl((CASE
                             WHEN (Rc + Rg) / EAD > 1.05 THEN
                              1.05
                             ELSE
                              (Rc + Rg) / EAD
                           END),
                           Ravg) * φ * ω AS SCORE， nvl((CASE
                    WHEN (Rc + Rg) / EAD > 1.05 THEN
                     1.05
                    ELSE
                     (Rc + Rg) / EAD
                  END), Ravg),
                  φ,
                  ω,
                  Rc,
                  Rg,
                  EAD,
                  Ravg
             FROM (select secinner_id,
                          company_id,
                          company_nm,
                          exposure,
                          sum((pledge_value - priority_value) * pledge_type *
                              pledge_control * pledge_region * pledge_depend) as Rc,
                          (bond_type) as φ,
                          avg(corp_nature * industry * credit_region) as ω,
                          (0.35) as Ravg,
                          sum(warranty_value * guarantee_type * warrantor_type *
                              warranty_strength) as Rg,
                          (remain_vol) as EAD
                     from (select * from tmp_Ret)
                    group by secinner_id,
                             company_id,
                             company_nm,
                             exposure,
                             bond_type,
                             remain_vol)) A
    LEFT JOIN BOND_RATING_SCALE_LGD TT
      ON TT.LOW_BOUND < A.SCORE
     AND TT.UPPER_BOUND > A.SCORE)
select * from TEMP where secinner_id = '122152.sh';



```
