```sql
-- 确定核对债券的范围
with temp_bond_basicinfo as
(select
   a.secinner_id,
   a.security_cd || c.market_abbr as security_cd
 from (select distinct
         secinner_id,
         security_cd,
         trade_market_id
       from bond_basicinfo
       where isdel = 0) a
   join lkp_charcode b
     on a.trade_market_id = b.constant_id
        and b.constant_type = 206
   join lkp_market_abbr c
     on b.constant_cd = c.market_cd),

    bond_result as
  (select
     a.security_cd,
     c.secinner_id
   from ray_bond_list a
     left join temp_bond_basicinfo c
       on c.security_cd = a.security_cd),

  -- 多担保人的债券清单
    mutl_warror_list as (
      select
        t.secinner_id,
        t1.company_id,
        t.warrantor_nm,
        count(*)
        over (
          partition by t.secinner_id ) as warror_cnt
      from vw_bond_rating_cacul_warrantor t
        left join compy_basicinfo t1
          on t1.company_nm = t.warrantor_nm
             and t1.is_del = 0
      where t.client_id = 5 and t.secinner_id in (
        select secinner_id
        from bond_result
      ) and t.client_id = 5),

  -- 多抵质押物的债券清单
    mutl_pledge_list as (
      select
        t.secinner_id,
        t.pledge_nm,
        count(*)
        over (
          partition by t.secinner_id ) as pldge_cnt
      from vw_bond_rating_cacul_pledge t
      where t.secinner_id in (
        select secinner_id
        from bond_result
      )
            and t.client_id = 5),
  -- 债券的基本信息 list
    bond_basicinfo_list as (
      select
        a.secinner_id,
        a.security_cd,
        a2.factor_cd,
        a2.factor_type,
        a2.factor_value,
        a2.option_num,
        a2.ratio,
        coalesce(to_char(a2.ratio), a2.factor_value) as final_ratio,
        a2.orig_record_sid
      from bond_result a
        inner join bond_rating_display a1
          on a1.secinner_id = a.secinner_id
        inner join bond_rating_factor a2
          on a1.bond_rating_record_id = a2.bond_rating_record_sid
             and a2.client_id = a1.client_id
      where a1.client_id = 5),
  -- 债券的基本信息 ration
    bond_basicinfo_ration as (
      select *
      from (
        select
          security_cd,
          secinner_id,
          factor_cd,
          final_ratio
        from bond_basicinfo_list
        --         where factor_cd in ('remain_vol',
        --                             'corp_nature',
        --                             'industry',
        --                             'credit_region',
        --                             'bond_type')
      )
        pivot (
          max(final_ratio)
          for factor_cd
          in ('remain_vol' as "债券风险暴露ead(亿元)",
            'corp_nature' as "股权结构",
            'industry' as "发行人行业分类",
            'credit_region' as "信用环境",
            'bond_type' as "债项类型"))),
  -- 债券的基本信息 option
    bond_basicinfo_option as (
      select *
      from (
        select
          secinner_id,
          security_cd,
          factor_cd,
          option_num
        from bond_basicinfo_list
        where factor_cd in ('remain_vol',
                            'corp_nature',
                            'industry',
                            'credit_region',
                            'bond_type'))
        pivot (
          max(option_num)
          for factor_cd
          in ('corp_nature' as "股权结构",
            'industry' as "发行人行业分类",
            'credit_region' as "信用环境",
            'bond_type' as "债项类型"))),
  -- 关联多担保人的ratio
    mutl_warror_ratio as (
      select *
      from (
        select
          t.secinner_id,
          t.security_cd,
          t.factor_cd,
          t.final_ratio,
          t.orig_record_sid as rnt
        from bond_basicinfo_list t
        where t.secinner_id in (
          select secinner_id
          from mutl_warror_list
        )
              and factor_cd in ('warranty_strength',
                                'warrantor_type',
                                'guarantee_type',
                                'warranty_value',
                                'warrantor_nm'))
        pivot (
          max(final_ratio)
          for factor_cd
          in ('warrantor_nm' as "担保人名称",
            'warranty_strength' as "担保强度",
            'warrantor_type' as "担保人类型",
            'guarantee_type' as "担保类型",
            'warranty_value' as "担保价值")
        )),

  -- 关联多担保人的option
    mutl_warror_option as (
      select *
      from (
        select
          t.secinner_id,
          t.security_cd,
          t.factor_cd,
          t.option_num,
          t.orig_record_sid as rnt
        from bond_basicinfo_list t
        where t.secinner_id in (
          select secinner_id
          from mutl_warror_list
        )
              and factor_cd in ('warranty_strength',
                                'warrantor_type',
                                'guarantee_type',
                                'warranty_value',
                                'warrantor_nm'))
        pivot (
          max(option_num)
          for factor_cd
          in ('warrantor_nm' as "担保人名称",
            'warranty_strength' as "担保强度",
            'warrantor_type' as "担保人类型",
            'guarantee_type' as "担保类型",
            'warranty_value' as "担保价值")
        )),
  -- 关联多抵质押物的ratio
    mutl_pledge_ratio as (
      select *
      from (
        select
          t.secinner_id,
          t.security_cd,
          t.factor_cd,
          t.final_ratio,
          t.orig_record_sid as rnt
        from bond_basicinfo_list t
        where t.secinner_id in (
          select secinner_id
          from mutl_pledge_list
        )
              and factor_cd in ('pledge_depend',
                                'pledge_region',
                                'pledge_control',
                                'pledge_type',
                                'pledge_value'))
        pivot (
          max(final_ratio)
          for factor_cd
          in ('pledge_depend' as "抵质押品独立性",
            'pledge_region' as "抵质押品执法环境",
            'pledge_control' as "抵质押品控制力",
            'pledge_type' as "抵质押品类型",
            'pledge_value' as "抵质押品价值")
        )),
  -- 关联多抵质押物的option
    mutl_pledge_option as (
      select *
      from (
        select
          t.secinner_id,
          t.security_cd,
          t.factor_cd,
          t.option_num,
          t.orig_record_sid as rnt
        from bond_basicinfo_list t
        where t.secinner_id in (
          select secinner_id
          from mutl_pledge_list
        )
              and factor_cd in ('pledge_depend',
                                'pledge_region',
                                'pledge_control',
                                'pledge_type',
                                'pledge_value'))
        pivot (
          max(option_num)
          for factor_cd
          in ('pledge_depend' as "抵质押品独立性",
            'pledge_region' as "抵质押品执法环境",
            'pledge_control' as "抵质押品控制力",
            'pledge_type' as "抵质押品类型",
            'pledge_value' as "抵质押品价值")
        )),
  -- 关联出基本信息的ratio
    mutl_pledge_ratio_sum as (
      select
        t.secinner_id,
        t.security_cd,
        sum(抵质押品独立性 * 抵质押品执法环境 * 抵质押品控制力 * 抵质押品类型 * 抵质押品价值) as "总质押物缓释价值"
      from mutl_pledge_ratio t
      group by t.secinner_id, t.security_cd),
    mutl_warror_ration_sum as (
      select
        t.secinner_id,
        t.security_cd,
        sum(担保强度 * 担保人类型 * 担保类型 * 担保价值) as "总担保人缓释价值"
      from mutl_warror_ratio t
      group by t.secinner_id, t.security_cd),
bond_part1 as (
select
  a.security_cd,
  a.secinner_id,
  b."总担保人缓释价值",
  c."总质押物缓释价值"
from bond_basicinfo_ration a
  left join mutl_warror_ration_sum b
    on a.secinner_id = b.secinner_id
  left join mutl_pledge_ratio_sum c
    on a.secinner_id = c.secinner_id)
    select * from bond_result a
    inner join bond_rating_record b
      on b.secinner_id = a.secinner_id 
```
